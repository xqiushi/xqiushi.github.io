<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤©åœ°å›¾+é«˜å¾·é€†åœ°ç†ç¼–ç ï¼ˆå¹¿å®‰å¸‚ï¼‰</title>
    <script type="text/javascript" src="http://api.tianditu.gov.cn/api?v=4.0&tk="></script>
    <script>
        // åœ¨é¡µé¢åŠ è½½å®ŒæˆååŠ¨æ€åŠ è½½å¤©åœ°å›¾API
        window.addEventListener('DOMContentLoaded', function() {
            var tiandituApiKey = localStorage.getItem('tianditu_api_key') || document.getElementById('input-tianditu-key').value.trim();
            if (tiandituApiKey) {
                var script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = 'http://api.tianditu.gov.cn/api?v=4.0&tk=' + tiandituApiKey;
                script.onload = function() {
                    console.log('å¤©åœ°å›¾APIåŠ è½½æˆåŠŸ');
                    // åˆå§‹åŒ–åœ°å›¾
                    if (typeof initMap === 'function') {
                        initMap();
                    }
                };
                script.onerror = function() {
                    console.error('å¤©åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥');
                    alert('å¤©åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥APIå¯†é’¥');
                };
                document.head.appendChild(script);
            }
        });
    </script>
    <script src="https://unpkg.com/wind-layer@2.1.0/dist/wind-layer.min.js"></script>
    <!-- Leaflet CSS removed as Windy API loads its own fixed styles -->
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #mapDiv {
            width: 100%;
            height: 100vh;
        }
        
        #windy {
            width: 100%;
            height: 100vh;
            display: none;
        }
        
        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            width: auto;
            z-index: 1000;
            font-size: 14px;
        }
        
        .info-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 2px solid #2d94e4;
            padding-bottom: 5px;
        }
        
        .info-item {
            margin-bottom: 8px;
        }
        
        .info-label {
            font-weight: bold;
            color: #555;
            display: inline-block;
            width: 80px;
        }
        
        .info-value {
            color: #333;
        }
        
        /* ç¡®ä¿å•é€‰æŒ‰é’®å¯è§ */
        input[type="radio"] {
            width: 16px !important;
            height: 16px !important;
            margin-right: 8px !important;
            cursor: pointer !important;
            transform: scale(1.2) !important;
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
        }
        
        input[type="radio"]:checked {
            accent-color: #2d94e4 !important;
        }
        
        /* ç‰¹åˆ«é’ˆå¯¹windyå•é€‰æŒ‰é’® */
        #windy {
            display: inline-block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

    </style>
</head>
<body>
    <div id="mapDiv"></div>
    <div id="windy"></div>
    
    <!-- å›¾å±‚æ§åˆ¶é¢æ¿ -->
    <div id="layer-panel" style="position:absolute;bottom:10px;right:10px;background:rgba(255,255,255,0.9);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);z-index:1000;font-size:14px;">
        <div style="font-weight:bold;color:#333;margin-bottom:10px;border-bottom:2px solid #2d94e4;padding-bottom:5px;">ğŸ—ºï¸ å›¾å±‚é€‰æ‹©</div>
        <div style="margin-bottom:8px;">
            <input type="radio" id="tianditu" name="mapType" value="tianditu" checked>
            <label for="tianditu" style="cursor:pointer;color:#333;margin-left:5px;">ğŸŒ å¤©åœ°å›¾</label>
        </div>
        <div style="margin-bottom:8px;">
            <input type="radio" id="sichuan_image" name="mapType" value="sichuan_image">
            <label for="sichuan_image" style="cursor:pointer;color:#333;margin-left:5px;">ğŸ‡ºğŸ‡³ å››å·å›¾</label>
        </div>
        <div style="margin-bottom:8px;">
            <input type="radio" id="windy" name="mapType" value="windy">
            <label for="windy" style="cursor:pointer;color:#333;margin-left:5px;">ğŸŒ¤ï¸ Windyå¤©æ°”åœ°å›¾</label>
        </div>

    </div>
    
    <!-- æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦æŸ¥è¯¢é¢æ¿ -->
    <div style="position:absolute;top:10px;left:10px;background:rgba(255,255,255,0.9);padding:15px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.2);z-index:1000;font-size:14px;max-width:280px;">
        <div style="font-weight:bold;color:#333;margin-bottom:10px;border-bottom:2px solid #2d94e4;padding-bottom:5px;">ğŸ“ åæ ‡æŸ¥è¯¢</div>
        
        <!-- APIå¯†é’¥è¾“å…¥ -->
        <div style="margin-bottom:8px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">ğŸ”‘ å¤©åœ°å›¾APIå¯†é’¥:</label>
            <input type="password" id="input-tianditu-key" placeholder="è¾“å…¥æ‚¨çš„å¤©åœ°å›¾APIå¯†é’¥" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:11px;" 
                   value="">
            <div style="font-size:10px;color:#888;margin-top:2px;">å¯åœ¨ <a href="http://lbs.tianditu.gov.cn/" target="_blank" style="color:#2196f3;">å¤©åœ°å›¾å¼€æ”¾å¹³å°</a> ç”³è¯·</div>
        </div>

        <div style="margin-bottom:8px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">ğŸ”‘ å››å·å›¾APIå¯†é’¥:</label>
            <input type="password" id="input-sichuan-key" placeholder="è¾“å…¥æ‚¨çš„å››å·å›¾APIå¯†é’¥" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:11px;" 
                   value="">
            <div style="font-size:10px;color:#888;margin-top:2px;">å¯åœ¨ <a href="http://www.scgis.com.cn/" target="_blank" style="color:#2196f3;">å››å·çœåœ°ç†ä¿¡æ¯å…¬å…±æœåŠ¡å¹³å°</a> ç”³è¯·</div>
        </div>

        <div style="margin-bottom:8px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">ğŸ”‘ é«˜å¾·é€†åœ°å€æŸ¥è¯¢å¯†é’¥:</label>
            <input type="password" id="input-apikey" placeholder="è¾“å…¥æ‚¨çš„é«˜å¾·WebæœåŠ¡APIå¯†é’¥" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:11px;" 
                   value="">
            <div style="font-size:10px;color:#888;margin-top:2px;">å¯åœ¨ <a href="https://console.amap.com/dev/key/app" target="_blank" style="color:#2196f3;">é«˜å¾·æ§åˆ¶å°</a> ç”³è¯·</div>
        </div>
        
        <!-- Windy APIå¯†é’¥è¾“å…¥ -->
        <div style="margin-bottom:8px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">ğŸŒ¤ï¸ Windyå¤©æ°”APIå¯†é’¥ï¼ˆpointï¼‰:</label>
            <input type="password" id="input-windy-apikey" placeholder="è¾“å…¥æ‚¨çš„Windy APIå¯†é’¥" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:11px;" 
                   value="">
            <div style="font-size:10px;color:#888;margin-top:2px;">å¯åœ¨ <a href="https://api.windy.com/keys" target="_blank" style="color:#2196f3;">Windy API</a> ç”³è¯·</div>
        </div>

        <div style="margin-bottom:8px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">ğŸŒ¤ï¸ Windyå¤©æ°”APIå¯†é’¥ï¼ˆmapï¼‰:</label>
            <input type="password" id="input-windy-map-apikey" placeholder="è¾“å…¥æ‚¨çš„Windyåœ°å›¾APIå¯†é’¥" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:11px;" 
                   value="">
            <div style="font-size:10px;color:#888;margin-top:2px;">ä¸“ç”¨äºWindyå¤©æ°”åœ°å›¾å›¾å±‚</div>
        </div>
        


        <button onclick="clearAllApiKeys()" 
                style="width:100%;padding:6px;background:#f5f5f5;color:#666;border:1px solid #ddd;border-radius:4px;cursor:pointer;font-size:11px;margin-top:5px;">
            ğŸ—‘ï¸ æ¸…ç©ºå¯†é’¥
        </button>
        <button onclick="saveAllApiKeys()" 
                style="width:100%;padding:6px;background:#4caf50;color:white;border:none;border-radius:4px;cursor:pointer;font-size:11px;margin-top:5px;">
            ğŸ’¾ ä¿å­˜å¯†é’¥
        </button>
        <div id="input-status" style="margin-top:8px;font-size:11px;color:#666;min-height:15px;"></div>
    </div>
    
    <div class="info-panel">
        <div class="info-title">
            åœ°ç†ä½ç½®ä¿¡æ¯
            <button onclick="queryByCoordinates()" 
                    style="float:right;padding:4px 8px;background:#2196f3;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;margin-left:10px;">
                ğŸ” æŸ¥è¯¢
            </button>
            <button onclick="copyLocationInfo()" 
                    style="float:right;padding:4px 8px;background:#2196f3;color:white;border:none;border-radius:3px;cursor:pointer;font-size:11px;margin-left:10px;">
                ğŸ“‹ å¤åˆ¶
            </button>
        </div>
        
        <!-- ç»åº¦çº¬åº¦è¾“å…¥æ¡† -->
        <div style="margin-bottom:8px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">ç»åº¦:</label>
            <input type="number" id="info-lon" placeholder="å¦‚: 106.633" step="0.000001" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:12px;" value="106.633">
        </div>
        <div style="margin-bottom:10px;">
            <label style="display:block;color:#555;margin-bottom:3px;font-size:12px;">çº¬åº¦:</label>
            <input type="number" id="info-lat" placeholder="å¦‚: 30.455" step="0.000001" 
                   style="width:100%;padding:5px;border:1px solid #ddd;border-radius:3px;font-size:12px;" value="30.455">
        </div>
        

        <div class="info-item">
            <span class="info-label">è¯¦ç»†åœ°å€:</span>
            <span class="info-value" id="address">ç‚¹å‡»åœ°å›¾è·å–ä½ç½®ä¿¡æ¯</span>
        </div>
        <div class="info-item" style="display:none;">
            <span class="info-label">å®Œæ•´åœ°å€:</span>
            <span class="info-value" id="merged_address"></span>
        </div>
        <div class="info-item">
            <span class="info-label">æœ€è¿‘POI:</span>
            <span class="info-value" id="poi">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">æœ€è¿‘é“è·¯:</span>
            <span class="info-value" id="road">--</span>
        </div>
        <div class="info-item">
            <span class="info-label">å¤©æ°”ä¿¡æ¯:</span>
            <span class="info-value" id="weather-summary">--</span>
        </div>
    </div>
    


    <script type="text/javascript">
        console.log('è„šæœ¬å¼€å§‹æ‰§è¡Œ');
        
        var map;
        var currentMarker = null;
        var currentLayers = [];
        var currentMapType = 'tianditu'; // å½“å‰åœ°å›¾ç±»å‹

        
        // åˆ‡æ¢å›¾å±‚åŠŸèƒ½
        function switchLayer(layerType) {
            console.log('åˆ‡æ¢å›¾å±‚åˆ°:', layerType);
            
            if (!map) {
                console.warn('åœ°å›¾æœªåˆå§‹åŒ–ï¼Œæ— æ³•åˆ‡æ¢å›¾å±‚');
                return;
            }
            
            // ç§»é™¤å½“å‰å›¾å±‚
            currentLayers.forEach(function(layer) {
                try {
                    map.removeLayer(layer);
                } catch (e) {
                    console.warn('ç§»é™¤å›¾å±‚å¤±è´¥:', e);
                }
            });
            currentLayers = [];
            
            try {
                switch(layerType) {
                    case 'tianditu':
                        // å¤©åœ°å›¾å½±åƒå›¾å±‚
                        var tk = localStorage.getItem('tianditu_api_key') || document.getElementById('input-tianditu-key').value.trim();
                        if (!tk) {
                            console.warn('å¤©åœ°å›¾APIå¯†é’¥ç¼ºå¤±ï¼Œå°†ä½¿ç”¨é»˜è®¤å¯†é’¥æˆ–å¯¼è‡´åœ°å›¾åŠ è½½å¤±è´¥ã€‚');
                            // å¯ä»¥é€‰æ‹©æä¾›ä¸€ä¸ªé»˜è®¤çš„å…¬å…±å¯†é’¥ï¼Œæˆ–è€…è®©ç”¨æˆ·çŸ¥é“éœ€è¦å¡«å†™å¯†é’¥
                            // tk = 'YOUR_DEFAULT_TIANDITU_KEY'; // å¦‚æœæœ‰é»˜è®¤å…¬å…±å¯†é’¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®
                        }
                        var imageURL = "http://t0.tianditu.gov.cn/img_w/wmts?" +
                            "SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles" +
                            "&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}" +
                            "&tk=" + tk;
                        var imageAnnoURL = "http://t0.tianditu.gov.cn/cia_w/wmts?" +
                            "SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles" +
                            "&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}" +
                            "&tk=" + tk;
                        
                        var imgLayer = new T.TileLayer(imageURL, { minZoom: 1, maxZoom: 18 });
                        var imgAnnoLayer = new T.TileLayer(imageAnnoURL, { minZoom: 1, maxZoom: 18 });
                        
                        map.addLayer(imgLayer);
                        map.addLayer(imgAnnoLayer);
                        currentLayers.push(imgLayer, imgAnnoLayer);
                        
                        // ç§»é™¤å½“å‰å›¾å±‚æ˜¾ç¤º
                        console.log('å¤©åœ°å›¾å›¾å±‚åŠ è½½æˆåŠŸ');
                        break;
                        
                    case 'sichuan_image':
                        // å››å·å›¾ï¼ˆå½±åƒå›¾å±‚ï¼‰
                        console.log('åŠ è½½å››å·å›¾...');
                        
                        var sichuanImageLoaded = false;
                        var scKey = localStorage.getItem('sichuan_api_key') || document.getElementById('input-sichuan-key').value.trim();
                        if (!scKey) {
                            console.warn('å››å·å›¾APIå¯†é’¥ç¼ºå¤±ï¼Œå°†ä½¿ç”¨é»˜è®¤å¯†é’¥æˆ–å¯¼è‡´åœ°å›¾åŠ è½½å¤±è´¥ã€‚');
                            // å¯ä»¥é€‰æ‹©æä¾›ä¸€ä¸ªé»˜è®¤çš„å…¬å…±å¯†é’¥ï¼Œæˆ–è€…è®©ç”¨æˆ·çŸ¥é“éœ€è¦å¡«å†™å¯†é’¥
                            // scKey = 'YOUR_DEFAULT_SICHUAN_KEY'; // å¦‚æœæœ‰é»˜è®¤å…¬å…±å¯†é’¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®
                        }
                        
                        try {
                            console.log('åŠ è½½å››å·å›¾å½±åƒæœåŠ¡...');
                            
                            // ä½¿ç”¨æ–‡ä»¶1ä¸­çš„æ­£ç¡®æ ¼å¼ï¼šakå‚æ•°å’ŒreturnTipTileå‚æ•°
                            var scImageURL = 'https://www.scgis.net/services/newtianditudom_w/tile/{z}/{y}/{x}?returnTipTile=true&ak=' + scKey;
                            var scImageAnnoURL = 'https://www.scgis.net/services/newtianditudomdlg_w/tile/{z}/{y}/{x}?returnTipTile=true&ak=' + scKey;
                            
                            console.log('å½±åƒåº•å›¾URLæ¨¡æ¿:', scImageURL);
                            console.log('å½±åƒæ³¨è®°URLæ¨¡æ¿:', scImageAnnoURL);
                            
                            // åˆ›å»ºå½±åƒåº•å›¾å›¾å±‚
                            var scImageLayer = new T.TileLayer(scImageURL, { 
                                minZoom: 1, 
                                maxZoom: 18,
                                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                            });
                            
                            // åˆ›å»ºå½±åƒæ³¨è®°å›¾å±‚
                            var scImageAnnoLayer = new T.TileLayer(scImageAnnoURL, { 
                                minZoom: 1, 
                                maxZoom: 18,
                                errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                            });
                            
                            // æ·»åŠ ä¸¤ä¸ªå›¾å±‚åˆ°åœ°å›¾ï¼ˆå…ˆåº•å›¾ï¼Œå†æ³¨è®°ï¼‰
                            map.addLayer(scImageLayer);
                            map.addLayer(scImageAnnoLayer);
                            currentLayers.push(scImageLayer, scImageAnnoLayer);
                            sichuanImageLoaded = true;
                            
                            // ç§»é™¤å½“å‰å›¾å±‚æ˜¾ç¤º
                            console.log('å››å·å›¾åŠ è½½æˆåŠŸ');
                            
                        } catch (sichuanImageError) {
                            console.warn('å››å·å›¾åŠ è½½å¤±è´¥:', sichuanImageError);
                        }
                        

                        
                        // å¦‚æœå››å·å›¾å¤±è´¥ï¼Œä½¿ç”¨å¤©åœ°å›¾å½±åƒä½œä¸ºæ›¿ä»£
                        if (!sichuanImageLoaded) {
                            console.log('å››å·å›¾ä¸å¯ç”¨ï¼Œä½¿ç”¨å¤©åœ°å›¾å½±åƒä½œä¸ºæ›¿ä»£');
                            
                            try {
                                var tk = localStorage.getItem('tianditu_api_key') || document.getElementById('input-tianditu-key').value.trim();
                            if (!tk) {
                                console.warn('å¤©åœ°å›¾APIå¯†é’¥ç¼ºå¤±ï¼Œå°†ä½¿ç”¨é»˜è®¤å¯†é’¥æˆ–å¯¼è‡´åœ°å›¾åŠ è½½å¤±è´¥ã€‚');
                                // tk = 'YOUR_DEFAULT_TIANDITU_KEY'; // å¦‚æœæœ‰é»˜è®¤å…¬å…±å¯†é’¥ï¼Œå¯ä»¥åœ¨è¿™é‡Œè®¾ç½®
                            }
                                var imageURL = "http://t0.tianditu.gov.cn/img_w/wmts?" +
                                    "SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=img&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles" +
                                    "&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}" +
                                    "&tk=" + tk;
                                var imageAnnoURL = "http://t0.tianditu.gov.cn/cia_w/wmts?" +
                                    "SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cia&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles" +
                                    "&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}" +
                                    "&tk=" + tk;
                                
                                var imgLayer = new T.TileLayer(imageURL, { minZoom: 1, maxZoom: 18 });
                                var imgAnnoLayer = new T.TileLayer(imageAnnoURL, { minZoom: 1, maxZoom: 18 });
                                
                                map.addLayer(imgLayer);
                                map.addLayer(imgAnnoLayer);
                                currentLayers.push(imgLayer, imgAnnoLayer);
                                
                                // ç§»é™¤å½“å‰å›¾å±‚æ˜¾ç¤º
                                console.log('å¤©åœ°å›¾å½±åƒæ›¿ä»£æ–¹æ¡ˆåŠ è½½æˆåŠŸ');
                                
                            } catch (fallbackError) {
                                console.error('å½±åƒæ›¿ä»£æ–¹æ¡ˆä¹Ÿå¤±è´¥ï¼Œå›é€€åˆ°å¤©åœ°å›¾');
                                // ç§»é™¤å½“å‰å›¾å±‚æ˜¾ç¤º
                                document.getElementById('tianditu').checked = true;
                                switchLayer('tianditu');
                                return;
                            }
                        }
                        break;
                        
                    case 'windy':
                        console.log('åˆ‡æ¢åˆ°Windyå¤©æ°”åœ°å›¾');
                        // éšè—å¤©åœ°å›¾å®¹å™¨ï¼Œæ˜¾ç¤ºWindyå®¹å™¨
                        document.getElementById('mapDiv').style.display = 'none';
                        document.getElementById('windy').style.display = 'block';
                        // è¿™é‡Œéœ€è¦æ ¹æ®Windy APIçš„å®é™…é›†æˆæ–¹å¼æ¥åŠ è½½é£åœºå›¾å±‚
                        // ç”±äºwind-layeræ˜¯åŸºäºLeafletçš„ï¼Œè€Œå¤©åœ°å›¾APIä¸æ˜¯Leafletï¼Œè¿™é‡Œæ— æ³•ç›´æ¥é›†æˆ
                        // æš‚æ—¶åªåšUIåˆ‡æ¢ï¼Œä¸åŠ è½½å®é™…çš„ç²’å­é£åœºå›¾å±‚
                        console.warn('Windyå¤©æ°”åœ°å›¾åŠŸèƒ½éœ€è¦å•ç‹¬é›†æˆï¼Œå½“å‰ä»…æ˜¾ç¤ºå…¶å®¹å™¨ã€‚');
                        break;
                    default:
                        console.warn('æœªçŸ¥çš„å›¾å±‚ç±»å‹:', layerType);
                        // é»˜è®¤ä½¿ç”¨å¤©åœ°å›¾
                        switchLayer('tianditu');
                        return;
                }
                

            } catch (error) {
                console.error('å›¾å±‚åˆ‡æ¢å¤±è´¥:', error);

                // é”™è¯¯æ—¶å›é€€åˆ°å¤©åœ°å›¾
                if (layerType !== 'tianditu') {
                    console.log('å›é€€åˆ°å¤©åœ°å›¾');
                    document.getElementById('tianditu').checked = true;
                    switchLayer('tianditu');
                }
            }
        }
        
        // ç»‘å®šå›¾å±‚åˆ‡æ¢äº‹ä»¶ï¼ˆå·²åˆå¹¶åˆ°setupMapTypeListenersä¸­ï¼‰
        function bindLayerEvents() {
            // æ­¤å‡½æ•°å·²åºŸå¼ƒï¼ŒåŠŸèƒ½åˆå¹¶åˆ°setupMapTypeListeners
            console.log('bindLayerEventså·²åºŸå¼ƒï¼Œä½¿ç”¨setupMapTypeListeners');
        }
        
        function initMap() {
            console.log('å¼€å§‹åˆå§‹åŒ–åœ°å›¾');

            try {
                // æ£€æŸ¥APIæ˜¯å¦åŠ è½½
                if (typeof T === 'undefined') {
                    throw new Error('å¤©åœ°å›¾APIæœªåŠ è½½');
                }
                
                // æ£€æŸ¥å¿…è¦çš„ç±»æ˜¯å¦å­˜åœ¨
                console.log('æ£€æŸ¥å¤©åœ°å›¾APIç±»:', {
                    'T.Map': typeof T.Map,
                    'T.LngLat': typeof T.LngLat,
                    'T.TileLayer': typeof T.TileLayer,
                    'T.Marker': typeof T.Marker
                });
                
                if (!T.Map) {
                    throw new Error('T.Mapç±»ä¸å­˜åœ¨');
                }
                
                // åˆ›å»ºåœ°å›¾å®ä¾‹ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
                map = new T.Map('mapDiv');
                console.log('åœ°å›¾å®ä¾‹åˆ›å»ºæˆåŠŸ');
                
                // è®¾ç½®åˆå§‹ç»çº¬åº¦
                document.getElementById('info-lon').value = '106.63572';
                document.getElementById('info-lat').value = '30.463984';
                // è®¾ç½®ä¸­å¿ƒç‚¹ï¼ˆå››å·çœå¹¿å®‰å¸‚ï¼‰
                var centerPoint = new T.LngLat(106.63572, 30.463984);
                map.centerAndZoom(centerPoint, 12);
                console.log('åœ°å›¾ä¸­å¿ƒç‚¹è®¾ç½®æˆåŠŸ');
                
                // æ ¹æ®é»˜è®¤é€‰ä¸­çš„å•é€‰æŒ‰é’®åˆå§‹åŒ–å›¾å±‚
                var defaultMapType = document.querySelector('input[name="mapType"]:checked').value;
                console.log('é»˜è®¤åœ°å›¾ç±»å‹:', defaultMapType);
                switchLayer(defaultMapType);
                
                // ç»‘å®šå›¾å±‚åˆ‡æ¢äº‹ä»¶
                bindLayerEvents();
                console.log('å›¾å±‚åˆ‡æ¢äº‹ä»¶ç»‘å®šæˆåŠŸ');
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                map.addEventListener('click', function(e) {
                    console.log('åœ°å›¾è¢«ç‚¹å‡»');
                    var lngLat = e.lnglat;
                    var lon = lngLat.getLng();
                    var lat = lngLat.getLat();
                    
                    // ç»çº¬åº¦ä¿¡æ¯å°†åœ¨getAddresså‡½æ•°ä¸­ä¸åœ°å€åˆå¹¶æ˜¾ç¤º
                    
                    // åŒæ­¥æ›´æ–°åˆ°åœ°ç†ä½ç½®ä¿¡æ¯é¢æ¿çš„ç»çº¬åº¦è¾“å…¥æ¡†
                    document.getElementById('info-lon').value = lon.toFixed(6);
                    document.getElementById('info-lat').value = lat.toFixed(6);
                    
                    console.log('ç‚¹å‡»ä½ç½®å·²åŒæ­¥åˆ°è¾“å…¥æ¡†:', lon.toFixed(6), lat.toFixed(6));
                    
                    // ç§»é™¤æ—§æ ‡è®°
                    if (currentMarker) {
                        map.removeOverLay(currentMarker);
                    }
                    
                    // æ·»åŠ æ–°æ ‡è®°
                    currentMarker = new T.Marker(lngLat);
                    map.addOverLay(currentMarker);
                    
                    // è·å–åœ°å€
                    getAddress(lon, lat);
                });
                
console.log('åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
            
            // å…ˆåŠ è½½ä¿å­˜çš„APIå¯†é’¥
            loadAllApiKeys();
            
            // è®¾ç½®è¾“å…¥äº‹ä»¶ç›‘å¬
            setupInputEvents();
            

                
            } catch (error) {
                console.error('åœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);

                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                document.getElementById('mapDiv').innerHTML = 
                    '<div style="display:flex;justify-content:center;align-items:center;height:100%;background:#f5f5f5;flex-direction:column;">' +
                    '<h2 style="color:#e74c3c;">åœ°å›¾åŠ è½½å¤±è´¥</h2>' +
                    '<p>é”™è¯¯ä¿¡æ¯: ' + error.message + '</p>' +
                    '<p>è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIå¯†é’¥</p>' +
                    '<button onclick="location.reload()" style="padding:10px 20px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">é‡æ–°åŠ è½½</button>' +
                    '</div>';
            }
        }
        
        // å°†é£å‘è§’åº¦è½¬æ¢ä¸ºæ–¹ä½è§’æè¿°
        function getWindDirectionText(degrees) {
            var directions = [
                'åŒ—', 'åŒ—ä¸œåŒ—', 'ä¸œåŒ—', 'ä¸œä¸œåŒ—',
                'ä¸œ', 'ä¸œä¸œå—', 'ä¸œå—', 'å—ä¸œå—',
                'å—', 'å—è¥¿å—', 'è¥¿å—', 'è¥¿è¥¿å—',
                'è¥¿', 'è¥¿è¥¿åŒ—', 'è¥¿åŒ—', 'åŒ—è¥¿åŒ—'
            ];
            var index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }
        
        // è·å–Windyå¤©æ°”æ•°æ®
        function getWindyWeather(lon, lat) {
            // è·å–Windy APIå¯†é’¥ï¼ˆpointï¼‰ç”¨äºå¤©æ°”ä¿¡æ¯
            var windyApiKey = localStorage.getItem('windy_api_key') || document.getElementById('input-windy-apikey').value.trim();
            if (!windyApiKey) {
                document.getElementById('weather-summary').textContent = 'æœªé…ç½®Windy APIï¼ˆpointï¼‰';
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('weather-summary').textContent = 'è·å–å¤©æ°”ä¿¡æ¯ä¸­...';
            
            // ä½¿ç”¨Windy Point Forecast API
            var requestData = {
                "lat": parseFloat(lat.toFixed(2)),
                "lon": parseFloat(lon.toFixed(2)),
                "model": "gfs",
                "parameters": ["temp", "wind", "precip", "rh", "lclouds", "mclouds", "hclouds"],
                "levels": ["surface"],
                "key": windyApiKey
            };
            
            fetch('https://api.windy.com/api/point-forecast/v2', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('APIè¯·æ±‚å¤±è´¥: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('Windyå¤©æ°”æ•°æ®:', data);
                
                if (data.ts && data.ts.length > 0) {
                    // è·å–æœ€æ–°çš„å¤©æ°”æ•°æ®ï¼ˆç¬¬ä¸€ä¸ªæ—¶é—´ç‚¹ï¼‰
                    var currentIndex = 0;
                    
                    // æ”¶é›†å¤©æ°”æ•°æ®
                    var weatherData = {
                        temperature: 'æ— æ•°æ®',
                        humidity: 'æ— æ•°æ®',
                        windSpeed: 'æ— æ•°æ®',
                        windDirection: 'æ— æ•°æ®',
                        location: 'å½“å‰ä½ç½®',
                        weatherCondition: 'æ™´'
                    };
                    
                    // æ¸©åº¦æ•°æ®
                    if (data['temp-surface'] && data['temp-surface'][currentIndex] !== null) {
                        var temp = Math.round(data['temp-surface'][currentIndex] - 273.15); // è½¬æ¢ä¸ºæ‘„æ°åº¦
                        weatherData.temperature = temp + 'Â°C';
                    }
                    
                    // æ¹¿åº¦æ•°æ®
                    if (data['rh-surface'] && data['rh-surface'][currentIndex] !== null) {
                        var humidity = Math.round(data['rh-surface'][currentIndex]);
                        weatherData.humidity = humidity + '%';
                    }
                    
                    // é£é€Ÿå’Œé£å‘æ•°æ®
                    if (data['wind_u-surface'] && data['wind_v-surface'] && 
                        data['wind_u-surface'][currentIndex] !== null && data['wind_v-surface'][currentIndex] !== null) {
                        var u = data['wind_u-surface'][currentIndex];
                        var v = data['wind_v-surface'][currentIndex];
                        var windSpeed = Math.sqrt(u * u + v * v);
                        weatherData.windSpeed = windSpeed.toFixed(1) + 'm/s';
                        
                        // è®¡ç®—é£å‘ï¼ˆè§’åº¦ï¼‰
                        var windDirection = Math.atan2(u, v) * 180 / Math.PI;
                        if (windDirection < 0) windDirection += 360;
                        
                        // è½¬æ¢ä¸ºæ–¹ä½è§’æè¿°
                        var directionText = getWindDirectionText(windDirection);
                        weatherData.windDirection = directionText;
                    }
                    
                    // è·å–åœ°å€ä¿¡æ¯ä½œä¸ºä½ç½®
                    var addressElement = document.getElementById('merged_address');
                    if (addressElement && addressElement.textContent && addressElement.textContent !== '--') {
                        var fullAddress = addressElement.textContent;
                        // æå–åŒºå¿ä¿¡æ¯ä½œä¸ºä½ç½®
                        var match = fullAddress.match(/(\S+å¸‚\S+åŒº|\S+å¸‚\S+å¿|\S+åŒº|\S+å¿)/);
                        if (match) {
                            weatherData.location = match[1];
                        }
                    }
                    
                    // ç”Ÿæˆåˆå¹¶çš„å¤©æ°”ä¿¡æ¯ï¼ˆéœ€è¦åœ¨é™æ°´æ•°æ®å¤„ç†åï¼‰
                    // è¿™é‡Œå…ˆè®¾ç½®ä¸€ä¸ªä¸´æ—¶å€¼ï¼Œå®é™…çš„å¤©æ°”ä¿¡æ¯ä¼šåœ¨é™æ°´æ•°æ®å¤„ç†åæ›´æ–°
                    
                    // é™æ°´æ•°æ®å’Œäº‘é‡æ•°æ®å¤„ç†ï¼Œåˆ¤æ–­å¤©æ°”çŠ¶å†µ
                    var precip = 0;
                    if (data['precip-surface'] && data['precip-surface'][currentIndex] !== null) {
                        precip = data['precip-surface'][currentIndex];
                        console.log('é™æ°´é‡:', precip);
                    }
                    
                    // è·å–äº‘é‡æ•°æ®
                    var lowClouds = 0, midClouds = 0, highClouds = 0;
                    if (data['lclouds-surface'] && data['lclouds-surface'][currentIndex] !== null) {
                        lowClouds = data['lclouds-surface'][currentIndex];
                    }
                    if (data['mclouds-surface'] && data['mclouds-surface'][currentIndex] !== null) {
                        midClouds = data['mclouds-surface'][currentIndex];
                    }
                    if (data['hclouds-surface'] && data['hclouds-surface'][currentIndex] !== null) {
                        highClouds = data['hclouds-surface'][currentIndex];
                    }
                    
                    console.log('äº‘é‡æ•°æ® - ä½äº‘:', lowClouds, 'ä¸­äº‘:', midClouds, 'é«˜äº‘:', highClouds);
                    
                    // è®¡ç®—æ€»äº‘é‡ï¼ˆå–æœ€å¤§å€¼ä½œä¸ºä¸»è¦äº‘é‡æŒ‡æ ‡ï¼‰
                    var totalCloudCover = Math.max(lowClouds, midClouds, highClouds);
                    
                    // æ ¹æ®é™æ°´é‡å’Œäº‘é‡ç»¼åˆåˆ¤æ–­å¤©æ°”çŠ¶å†µ
                    if (precip > 2.0) {
                        weatherData.weatherCondition = 'é›¨';
                    } else if (precip > 0.1) {
                        weatherData.weatherCondition = 'å°é›¨';
                    } else if (totalCloudCover > 80) {
                        weatherData.weatherCondition = 'é˜´';
                    } else if (totalCloudCover > 50) {
                        weatherData.weatherCondition = 'å¤šäº‘';
                    } else if (totalCloudCover > 20) {
                        weatherData.weatherCondition = 'å°‘äº‘';
                    } else {
                        weatherData.weatherCondition = 'æ™´';
                    }
                     
                     // ç”Ÿæˆæœ€ç»ˆçš„å¤©æ°”ä¿¡æ¯æ˜¾ç¤º
                     var weatherSummary = weatherData.location + 'ï¼Œ' + weatherData.weatherCondition + 
                                        'ï¼Œæ¸©åº¦' + weatherData.temperature + 
                                        'ï¼Œæ¹¿åº¦' + weatherData.humidity + 
                                        'ï¼Œ' + weatherData.windDirection + weatherData.windSpeed;
                     
                     document.getElementById('weather-summary').textContent = weatherSummary;
                } else {
                    document.getElementById('weather-summary').textContent = 'æ— æ•°æ®';
                }
            })
            .catch(error => {
                console.error('è·å–Windyå¤©æ°”æ•°æ®å¤±è´¥:', error);
                document.getElementById('weather-summary').textContent = 'APIé”™è¯¯';
            });
        }
        
        function getAddress(lon, lat) {
            console.log('å¼€å§‹è·å–åœ°å€:', lon, lat);
            
            // è·å–ç”¨æˆ·è¾“å…¥çš„APIå¯†é’¥
            var apiKey = localStorage.getItem('amap_api_key') || document.getElementById('input-apikey').value.trim();
            console.log('å½“å‰é«˜å¾·APIå¯†é’¥:', apiKey ? 'å·²å¡«å†™' : 'æœªå¡«å†™');
            if (!apiKey) {
                console.error('é«˜å¾·APIå¯†é’¥ç¼ºå¤±ï¼Œæ— æ³•æŸ¥è¯¢åœ°å€ã€‚');
                document.getElementById('address').textContent = 'è¯·å…ˆè¾“å…¥é«˜å¾·APIå¯†é’¥';
                document.getElementById('merged_address').textContent = 'è¯·å…ˆè¾“å…¥é«˜å¾·APIå¯†é’¥ï¼Œ' + lon.toFixed(6) + ',' + lat.toFixed(6);
                document.getElementById('input-status').innerHTML = '<span style="color:#e74c3c;">âš ï¸ è¯·è¾“å…¥APIå¯†é’¥</span>';
                return;
            }
            
            // åŒæ—¶è·å–å¤©æ°”æ•°æ®
            getWindyWeather(lon, lat);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            document.getElementById('address').textContent = 'æ­£åœ¨æŸ¥è¯¢åœ°å€...';
            document.getElementById('merged_address').textContent = 'æ­£åœ¨æŸ¥è¯¢åœ°å€...';
            document.getElementById('poi').textContent = '--';
            document.getElementById('road').textContent = '--';
            
            // ä½¿ç”¨é«˜å¾·åœ°å›¾é€†åœ°ç†ç¼–ç API
            var script = document.createElement('script');
            var callbackName = 'amapCallback' + Date.now().toString();
            
            console.log('åˆ›å»ºé«˜å¾·åœ°å›¾å›è°ƒå‡½æ•°:', callbackName);
            console.log('ä½¿ç”¨APIå¯†é’¥:', apiKey.substring(0, 8) + '...');
            
            // è®¾ç½®è¶…æ—¶å¤„ç†
            var timeoutId = setTimeout(function() {
                console.error('é«˜å¾·åœ°å›¾åœ°å€æŸ¥è¯¢è¶…æ—¶ï¼Œç»çº¬åº¦:', lon.toFixed(6), lat.toFixed(6));
                document.getElementById('address').textContent = 'æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·é‡è¯•';
                document.getElementById('merged_address').textContent = 'æŸ¥è¯¢è¶…æ—¶ï¼Œè¯·é‡è¯•ï¼Œ' + lon.toFixed(6) + ',' + lat.toFixed(6);
                
                // æ¸…ç†èµ„æº
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                if (window[callbackName]) {
                    delete window[callbackName];
                }
            }, 15000);
            
            // å®šä¹‰å›è°ƒå‡½æ•°
            window[callbackName] = function(data) {
                clearTimeout(timeoutId);
                console.log('æ”¶åˆ°é«˜å¾·åœ°å›¾åœ°å€æŸ¥è¯¢å“åº”:', data);
                console.log('é«˜å¾·åœ°å›¾å“åº”çŠ¶æ€:', data ? data.status : 'æ— æ•°æ®');
                console.log('é«˜å¾·åœ°å›¾å“åº”regeocode:', data ? data.regeocode : 'æ— æ•°æ®');
                
                try {
                    if (data && data.status === "1" && data.regeocode) {
                        var regeocode = data.regeocode;
                        console.log('è§£æé«˜å¾·åœ°å›¾æ•°æ®:', regeocode);
                        
                        // æ˜¾ç¤ºä¸»è¦åœ°å€ï¼ˆåº”ç”¨åŒºå¿æ›¿æ¢ï¼‰
                        var mainAddress = regeocode.formatted_address || 'åœ°å€ä¿¡æ¯ä¸å¯ç”¨';
                        // å¦‚æœæœ‰åœ°å€ç»„ä»¶ï¼Œåº”ç”¨åŒºå¿æ›¿æ¢
                        if (regeocode.addressComponent && regeocode.addressComponent.district) {
                            var ac = regeocode.addressComponent;
                            var mappedDistrict = mapDistrictName(ac.district, ac.township);
                            // æ›¿æ¢åŸåœ°å€ä¸­çš„åŒºå¿åç§°
                            if (ac.district && mappedDistrict !== ac.district) {
                                mainAddress = mainAddress.replace(ac.district, mappedDistrict);
                            }
                        }
                        document.getElementById('address').textContent = mainAddress;
                        
                        // è§£æåœ°å€ç»„ä»¶
                        if (regeocode.addressComponent) {
                            var ac = regeocode.addressComponent;
                            console.log('åœ°å€ç»„ä»¶:', ac);
                            
                            // åŸå¸‚åŒºåŸŸä¸å…·ä½“åœ°å€åˆå¹¶æ˜¾ç¤ºï¼ˆä¸æ˜¾ç¤ºçœå¸‚ï¼‰
                            var cityInfo = '';
                            // åªæ˜¾ç¤ºåŒºå¿åŠä»¥ä¸‹ä¿¡æ¯ï¼Œä¸æ˜¾ç¤ºçœå’Œå¸‚
                            if (ac.district) {
                                // åŒºåŸŸæ˜ å°„ï¼šå°†åŸå±äºå‰é”‹åŒºçš„ç‰¹å®šåœ°æ–¹æ”¹ä¸ºç»å¼€åŒº
                                var mappedDistrict = mapDistrictName(ac.district, ac.township);
                                cityInfo += mappedDistrict;
                            }
                            
                            // å…·ä½“åœ°å€ä¿¡æ¯
                            var specificText = '';
                            if (ac.township) specificText += ac.township;
                            if (ac.neighborhood && ac.neighborhood.name) {
                                specificText += ac.neighborhood.name;
                            }
                            if (ac.building && ac.building.name) {
                                specificText += ac.building.name;
                            }
                            
                            // åˆå¹¶æ˜¾ç¤ºåœ°å€å’Œç»çº¬åº¦
                            var mergedText = '';
                            if (cityInfo) {
                                mergedText += cityInfo;
                            }
                            if (specificText) {
                                mergedText += specificText;
                            }
                            if (!mergedText) {
                                mergedText = regeocode.formatted_address || 'åœ°å€ä¿¡æ¯ä¸å¯ç”¨';
                            }
                            mergedText += 'ï¼Œ' + lon.toFixed(6) + ',' + lat.toFixed(6);
                            document.getElementById('merged_address').textContent = mergedText;
                            
                            // POIä¿¡æ¯ - é«˜å¾·åœ°å›¾è¿”å›çš„æ˜¯é™„è¿‘POIåˆ—è¡¨
                            if (regeocode.pois && regeocode.pois.length > 0) {
                                var poi = regeocode.pois[0]; // å–ç¬¬ä¸€ä¸ªæœ€è¿‘çš„POI
                                var poiText = poi.name;
                                if (poi.distance !== undefined) {
                                    poiText += ' (' + poi.distance + 'ç±³)';
                                }
                                if (poi.direction) {
                                    poiText += ' [æ–¹å‘:' + poi.direction + ']';
                                }
                                document.getElementById('poi').textContent = poiText;
                            } else {
                                document.getElementById('poi').textContent = '--';
                            }
                            
                            // é“è·¯ä¿¡æ¯ - é«˜å¾·åœ°å›¾è¿”å›çš„æ˜¯é“è·¯åˆ—è¡¨
                            if (regeocode.roads && regeocode.roads.length > 0) {
                                var road = regeocode.roads[0]; // å–ç¬¬ä¸€æ¡æœ€è¿‘çš„é“è·¯
                                var roadText = road.name;
                                if (road.distance !== undefined) {
                                    roadText += ' (' + road.distance + 'ç±³)';
                                }
                                if (road.direction) {
                                    roadText += ' [æ–¹å‘:' + road.direction + ']';
                                }
                                document.getElementById('road').textContent = roadText;
                            } else {
                                document.getElementById('road').textContent = '--';
                            }
                        }
                        
                        console.log('é«˜å¾·åœ°å›¾åœ°å€ä¿¡æ¯è§£æå®Œæˆ');
                        console.log('æ›´æ–°DOMå…ƒç´ : address, merged_address, poi, road');
                        
                    } else {
                        console.error('é«˜å¾·åœ°å›¾åœ°å€æŸ¥è¯¢è¿”å›å¼‚å¸¸æ•°æ®:', data);
                        console.error('åŸå§‹æ•°æ®:', JSON.stringify(data));
                        var errorMsg = 'æŸ¥è¯¢å¤±è´¥';
                        if (data && data.info) {
                            errorMsg += ': ' + data.info;
                        }
                        if (data && data.status) {
                            errorMsg += ' (çŠ¶æ€:' + data.status + ')';
                        }
                        document.getElementById('address').textContent = errorMsg;
                        document.getElementById('merged_address').textContent = errorMsg + 'ï¼Œ' + lon.toFixed(6) + ',' + lat.toFixed(6);
                    }
                } catch (parseError) {
                    console.error('è§£æé«˜å¾·åœ°å›¾æ•°æ®å¤±è´¥:', parseError);
                    console.error('é”™è¯¯è¯¦æƒ…:', parseError.message);
                    document.getElementById('address').textContent = 'æ•°æ®è§£æé”™è¯¯';
                    document.getElementById('merged_address').textContent = 'æ•°æ®è§£æé”™è¯¯ï¼Œ' + lon.toFixed(6) + ',' + lat.toFixed(6);
                }
                
                // æ¸…ç†èµ„æº
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                if (window[callbackName]) {
                    delete window[callbackName];
                }
            };
            
            // æ„å»ºé«˜å¾·åœ°å›¾é€†åœ°ç†ç¼–ç APIè¯·æ±‚URL
            // æ³¨æ„ï¼šé«˜å¾·åœ°å›¾çš„ç»çº¬åº¦æ ¼å¼æ˜¯ï¼šç»åº¦,çº¬åº¦
            var location = lon + ',' + lat;
            var baseUrl = 'https://restapi.amap.com/v3/geocode/regeo';
            var params = [
                'location=' + encodeURIComponent(location),
                'key=' + encodeURIComponent(apiKey),
                'radius=1000',
                'extensions=all', // ä½¿ç”¨allè·å–æ›´è¯¦ç»†çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬POIå’Œé“è·¯ï¼‰
                'callback=' + callbackName
            ];
            var url = baseUrl + '?' + params.join('&');
            
            console.log('é«˜å¾·åœ°å›¾è¯·æ±‚URL:', url);
            
            // è®¾ç½®è„šæœ¬å±æ€§
            script.src = url;
            script.async = true;
            script.charset = 'utf-8';
            
            // é”™è¯¯å¤„ç†
            script.onerror = function(error) {
                console.error('é«˜å¾·åœ°å›¾è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIå¯†é’¥ã€‚');
                clearTimeout(timeoutId);
                console.error('é«˜å¾·åœ°å›¾è„šæœ¬åŠ è½½å¤±è´¥:', error);
                document.getElementById('address').textContent = 'ç½‘ç»œè¯·æ±‚å¤±è´¥';
                document.getElementById('merged_address').textContent = 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œ' + lon.toFixed(6) + ',' + lat.toFixed(6);
                
                // æ¸…ç†èµ„æº
                if (script.parentNode) {
                    document.body.removeChild(script);
                }
                if (window[callbackName]) {
                    delete window[callbackName];
                }
            };
            
            // æ·»åŠ åˆ°æ–‡æ¡£
            document.body.appendChild(script);
        }
        
        // æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦æŸ¥è¯¢åœ°å€
        function queryByCoordinates() {
            // ä¼˜å…ˆè¯»å–åœ°ç†ä½ç½®ä¿¡æ¯é¢æ¿çš„è¾“å…¥æ¡†ï¼Œå¦‚æœä¸ºç©ºåˆ™è¯»å–åæ ‡æŸ¥è¯¢é¢æ¿çš„è¾“å…¥æ¡†
            var infoLon = document.getElementById('info-lon').value;
            var infoLat = document.getElementById('info-lat').value;
            
            var lon = parseFloat(infoLon);
            var lat = parseFloat(infoLat);
            var statusDiv = document.getElementById('input-status');
            
            // éªŒè¯è¾“å…¥
            if (isNaN(lon) || isNaN(lat)) {
                statusDiv.innerHTML = '<span style="color:#e74c3c;">âš ï¸ è¯·è¾“å…¥æœ‰æ•ˆçš„ç»çº¬åº¦</span>';
                return;
            }
            
            // éªŒè¯ç»çº¬åº¦èŒƒå›´
            if (lon < -180 || lon > 180 || lat < -90 || lat > 90) {
                statusDiv.innerHTML = '<span style="color:#e74c3c;">âš ï¸ ç»åº¦èŒƒå›´: -180åˆ°180ï¼Œçº¬åº¦èŒƒå›´: -90åˆ°90</span>';
                return;
            }
            
            statusDiv.innerHTML = '<span style="color:#2196f3;">ğŸ” æ­£åœ¨æŸ¥è¯¢...</span>';
            
            console.log('æ‰‹åŠ¨è¾“å…¥ç»çº¬åº¦æŸ¥è¯¢:', lon, lat);
            
            // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦æ›´æ–°ç»çº¬åº¦æ˜¾ç¤ºï¼Œå› ä¸ºç›¸å…³å…ƒç´ ä¸å­˜åœ¨
            
            // ç§»é™¤ä¹‹å‰çš„æ ‡è®°
            if (currentMarker) {
                map.removeOverLay(currentMarker);
            }
            
            // åˆ›å»ºæ–°æ ‡è®°å¹¶ç§»åŠ¨åœ°å›¾
            var lngLat = new T.LngLat(lon, lat);
            currentMarker = new T.Marker(lngLat);
            map.addOverLay(currentMarker);
            
            // ç§»åŠ¨åœ°å›¾ä¸­å¿ƒåˆ°æŒ‡å®šä½ç½®
            map.panTo(lngLat);
            
            // è·å–åœ°å€ä¿¡æ¯
            getAddress(lon, lat);
            
            // è·å–å¤©æ°”ä¿¡æ¯
            getWindyWeather(lon, lat);
            
            statusDiv.innerHTML = '<span style="color:#4caf50;">âœ“ æŸ¥è¯¢å®Œæˆ</span>';
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        function clearInputs() {
            document.getElementById('input-lon').value = '';
            document.getElementById('input-lat').value = '';
            document.getElementById('input-status').innerHTML = 'ğŸ“‹ è¯·è¾“å…¥ç»çº¬åº¦åæ ‡';
        }
        
        // æ¸…ç©ºæ‰€æœ‰APIå¯†é’¥
        function clearAllApiKeys() {
            var statusDiv = document.getElementById('input-status');
            
            try {
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('input-tianditu-key').value = '';
                document.getElementById('input-sichuan-key').value = '';
                document.getElementById('input-apikey').value = '';
                document.getElementById('input-windy-apikey').value = '';
                document.getElementById('input-windy-map-apikey').value = '';
                
                // ä»localStorageåˆ é™¤
                localStorage.removeItem('tianditu_api_key');
                localStorage.removeItem('sichuan_api_key');
                localStorage.removeItem('amap_api_key');
                localStorage.removeItem('windy_api_key');
                localStorage.removeItem('windy_map_api_key');
                
                statusDiv.innerHTML = '<span style="color:#666;">ğŸ—‘ï¸ å¯†é’¥å·²æ¸…ç©º</span>';
                
                // 3ç§’åæ¢å¤é»˜è®¤çŠ¶æ€
                setTimeout(function() {
                    statusDiv.innerHTML = 'ğŸ“‹ è¯·è¾“å…¥ç»çº¬åº¦åæ ‡';
                }, 3000);
            } catch (e) {
                statusDiv.innerHTML = '<span style="color:#e74c3c;">âš ï¸ æ¸…ç©ºå¤±è´¥</span>';
            }
        }
        
        // ä¿å­˜æ‰€æœ‰APIå¯†é’¥åˆ°æœ¬åœ°å­˜å‚¨
function saveAllApiKeys() {
    var tiandituKey = document.getElementById('input-tianditu-key').value.trim();
    var sichuanKey = document.getElementById('input-sichuan-key').value.trim();
    var amapKey = document.getElementById('input-apikey').value.trim();
    var windyPointKey = document.getElementById('input-windy-apikey').value.trim();
    var windyMapKey = document.getElementById('input-windy-map-apikey').value.trim();
    
    localStorage.setItem('tianditu_api_key', tiandituKey);
    localStorage.setItem('sichuan_api_key', sichuanKey);
    localStorage.setItem('amap_api_key', amapKey);
    localStorage.setItem('windy_api_key', windyPointKey);
    localStorage.setItem('windy_map_api_key', windyMapKey);
    
    alert('æ‰€æœ‰APIå¯†é’¥å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
}
        
        // åŠ è½½æ‰€æœ‰APIå¯†é’¥
        function loadAllApiKeys() {
            try {
                var savedTiandituKey = localStorage.getItem('tianditu_api_key');
                if (savedTiandituKey) {
                    document.getElementById('input-tianditu-key').value = savedTiandituKey;
                    console.log('å·²åŠ è½½ä¿å­˜çš„å¤©åœ°å›¾APIå¯†é’¥');
                }

                var savedSichuanKey = localStorage.getItem('sichuan_api_key');
                if (savedSichuanKey) {
                    document.getElementById('input-sichuan-key').value = savedSichuanKey;
                    console.log('å·²åŠ è½½ä¿å­˜çš„å››å·å›¾APIå¯†é’¥');
                }

                var savedAmapKey = localStorage.getItem('amap_api_key');
                if (savedAmapKey) {
                    document.getElementById('input-apikey').value = savedAmapKey;
                    console.log('å·²åŠ è½½ä¿å­˜çš„é«˜å¾·APIå¯†é’¥');
                }
                
                var savedWindyKey = localStorage.getItem('windy_api_key');
                if (savedWindyKey) {
                    document.getElementById('input-windy-apikey').value = savedWindyKey;
                    console.log('å·²åŠ è½½ä¿å­˜çš„Windy APIå¯†é’¥ï¼ˆpointï¼‰');
                }
                
                var savedWindyMapKey = localStorage.getItem('windy_map_api_key');
                if (savedWindyMapKey) {
                    document.getElementById('input-windy-map-apikey').value = savedWindyMapKey;
                    console.log('å·²åŠ è½½ä¿å­˜çš„Windy APIå¯†é’¥ï¼ˆmapï¼‰');
                }
            } catch (e) {
                console.warn('æ— æ³•åŠ è½½ä¿å­˜çš„APIå¯†é’¥:', e);
            }
        }
        
        // åŒºåŸŸåç§°æ˜ å°„å‡½æ•°ï¼šå°†ç‰¹å®šåœ°æ–¹çš„åŒºå¿åç§°è¿›è¡Œæ˜ å°„
        function mapDistrictName(district, township) {
            // å®šä¹‰ç°åœ¨å±äºç»å¼€åŒºçš„åœ°æ–¹ï¼ˆä¸è®ºåŸæ¥å±äºå“ªä¸ªåŒºå¿ï¼‰
            var economicZoneAreas = [
                'æ£å±±å›­åŒº',     // æ£å±±å›­åŒº
                'æ£å±±è¡—é“',     // æ£å±±è¡—é“
                'å¥é˜è¡—é“',     // å¥é˜è¡—é“
                'æ–°æ¡¥è¡—é“',     // æ–°æ¡¥è¡—é“
                'ç©¿çŸ³é•‡',       // ç©¿çŸ³é•‡
                'æŠ¤å®‰é•‡'        // æŠ¤å®‰é•‡
            ];
            
            // æ£€æŸ¥è¡—é“/é•‡åç§°æ˜¯å¦åœ¨ç»å¼€åŒºåˆ—è¡¨ä¸­
            if (township) {
                for (var i = 0; i < economicZoneAreas.length; i++) {
                    if (township.indexOf(economicZoneAreas[i]) !== -1) {
                        console.log('å‘ç°ç»å¼€åŒºåŒºåŸŸ:', township, 'ï¼Œå°†' + (district || 'åŸåŒºå¿') + 'æ”¹ä¸ºç»å¼€åŒº');
                        return 'ç»å¼€åŒº';
                    }
                }
            }
            
            // å¦‚æœä¸åœ¨ç»å¼€åŒºåˆ—è¡¨ä¸­ï¼Œè¿”å›åŸåŒºå
            return district || '--';
        }
        
        // ä»å®Œæ•´åœ°å€ä¸­æå–åŒºå¿ä¸ä¹¡é•‡ä¿¡æ¯
        function extractDistrictAndTownship(fullAddress) {
            // ç§»é™¤çœä»½ä¿¡æ¯ï¼Œåªä¿ç•™åŒºå¿åŠä»¥ä¸‹çº§åˆ«
            var address = fullAddress.replace(/^[^çœå¸‚]*[çœå¸‚]/, '');
            
            // æå–åŒºå¿ä¿¡æ¯ï¼ˆåŒ…å«"åŒº"ã€"å¿"ã€"å¸‚"ç­‰å…³é”®å­—ï¼‰
            var districtMatch = address.match(/([^,ï¼Œ]*?[åŒºå¿å¸‚])/); 
            var district = districtMatch ? districtMatch[1] : '';
            
            // æå–ä¹¡é•‡ä¿¡æ¯ï¼ˆåŒ…å«"é•‡"ã€"ä¹¡"ã€"è¡—é“"ç­‰å…³é”®å­—ï¼‰
            var townshipMatch = address.match(/([^,ï¼Œ]*?[é•‡ä¹¡]|[^,ï¼Œ]*?è¡—é“)/); 
            var township = townshipMatch ? townshipMatch[1] : '';
            
            // ç»„åˆåŒºå¿ä¸ä¹¡é•‡ä¿¡æ¯
            var result = '';
            if (district) {
                result += district;
            }
            // é¿å…é‡å¤ï¼Œå¦‚æœä¹¡é•‡ä¿¡æ¯å·²ç»åŒ…å«äº†åŒºå¿ä¿¡æ¯ï¼Œåˆ™ä¸å†é‡å¤æ·»åŠ åŒºå¿
            if (township && township !== district && !township.includes(district)) {
                result += (result ? ' ' : '') + township;
            } else if (township && township.includes(district)) {
                result = township; // å¦‚æœä¹¡é•‡ä¿¡æ¯åŒ…å«äº†åŒºå¿ä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨ä¹¡é•‡ä¿¡æ¯
            }
            
            return result || 'æœªçŸ¥åœ°åŒº';
        }
        
        // å¤åˆ¶åˆå¹¶åçš„åœ°å€å’Œç»çº¬åº¦ä¿¡æ¯åˆ°å‰ªè´´æ¿
        function copyLocationInfo() {
            var mergedText = document.getElementById('merged_address').textContent;
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆä¿¡æ¯
            if (!mergedText || mergedText === '--' || mergedText === 'ç‚¹å‡»åœ°å›¾è·å–ä½ç½®ä¿¡æ¯' || mergedText === 'æ­£åœ¨æŸ¥è¯¢åœ°å€...') {
                alert('âš ï¸ è¯·å…ˆç‚¹å‡»åœ°å›¾è·å–ä½ç½®ä¿¡æ¯');
                return;
            }
            
            // ä»é¢æ¿ä¸­è·å–ç»åº¦çº¬åº¦æ•°æ®
            var lon = document.getElementById('info-lon').value;
            var lat = document.getElementById('info-lat').value;
            
            // ä»å®Œæ•´åœ°å€ä¸­æå–åŒºå¿ä¸ä¹¡é•‡ä¿¡æ¯
            var districtAndTownship = extractDistrictAndTownship(mergedText);
            
            // æ„å»ºå¤åˆ¶å†…å®¹ï¼šåŒºå¿ä¸ä¹¡é•‡ + ç»åº¦ + çº¬åº¦
            var copyText = districtAndTownship + ' ' + lon + ',' + lat;
            
            console.log('å‡†å¤‡å¤åˆ¶çš„å†…å®¹:', copyText);
            
            // ä½¿ç”¨ç°ä»£APIå¤åˆ¶åˆ°å‰ªè´´æ¿
            if (navigator.clipboard && window.isSecureContext) {
                // ä½¿ç”¨ç°ä»£Clipboard API
                navigator.clipboard.writeText(copyText).then(function() {
                    console.log('å¤åˆ¶æˆåŠŸ');
                    showCopyStatus('âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                }).catch(function(err) {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    fallbackCopyTextToClipboard(copyText);
                });
            } else {
                // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyTextToClipboard(copyText);
            }
        }
        
        // é™çº§å¤åˆ¶æ–¹æ¡ˆï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
        function fallbackCopyTextToClipboard(text) {
            var textArea = document.createElement('textarea');
            textArea.value = text;
            
            // é¿å…æ»šåŠ¨åˆ°åº•éƒ¨
            textArea.style.top = '0';
            textArea.style.left = '0';
            textArea.style.position = 'fixed';
            textArea.style.opacity = '0';
            
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            
            try {
                var successful = document.execCommand('copy');
                if (successful) {
                    console.log('é™çº§å¤åˆ¶æˆåŠŸ');
                    showCopyStatus('âœ“ å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                } else {
                    console.warn('é™çº§å¤åˆ¶å¤±è´¥');
                    showCopyStatus('âš ï¸ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                }
            } catch (err) {
                console.error('é™çº§å¤åˆ¶å‡ºé”™:', err);
                showCopyStatus('âš ï¸ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
            }
            
            document.body.removeChild(textArea);
        }
        
        // æ˜¾ç¤ºå¤åˆ¶çŠ¶æ€æç¤º
        function showCopyStatus(message, type) {
            // åˆ›å»ºçŠ¶æ€æç¤ºå…ƒç´ 
            var statusDiv = document.createElement('div');
            statusDiv.textContent = message;
            statusDiv.style.cssText = 
                'position:fixed;top:20px;right:20px;padding:10px 15px;border-radius:5px;' +
                'font-size:14px;z-index:10000;box-shadow:0 2px 10px rgba(0,0,0,0.2);' +
                'transition:all 0.3s ease;';
            
            if (type === 'success') {
                statusDiv.style.background = '#4caf50';
                statusDiv.style.color = 'white';
            } else {
                statusDiv.style.background = '#f44336';
                statusDiv.style.color = 'white';
            }
            
            document.body.appendChild(statusDiv);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤
            setTimeout(function() {
                if (statusDiv.parentNode) {
                    statusDiv.style.opacity = '0';
                    setTimeout(function() {
                        if (statusDiv.parentNode) {
                            document.body.removeChild(statusDiv);
                        }
                    }, 300);
                }
            }, 3000);
        }
        function setupInputEvents() {
            var infoLonInput = document.getElementById('info-lon');
            var infoLatInput = document.getElementById('info-lat');
            
            // ä¸ºåœ°ç†ä½ç½®ä¿¡æ¯é¢æ¿çš„è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
            [infoLonInput, infoLatInput].forEach(function(input) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        queryByCoordinates();
                    }
                });
                
                // è¾“å…¥æ—¶åŒæ­¥åˆ°åæ ‡æŸ¥è¯¢é¢æ¿
                input.addEventListener('input', function() {
                    if (input.id === 'info-lon') {
                        document.getElementById('input-lon').value = input.value;
                    } else if (input.id === 'info-lat') {
                        document.getElementById('input-lat').value = input.value;
                    }
                });
            });
        }
        // Windyåœ°å›¾ç›¸å…³å˜é‡
         let windyMap = null;

        // åˆå§‹åŒ–Windyåœ°å›¾
         function initWindyMap() {
             if (windyMap) return;
             
             // ä¼˜å…ˆä½¿ç”¨mapå¯†é’¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨pointå¯†é’¥
             const windyMapApiKey = localStorage.getItem('windy_map_api_key') || document.getElementById('input-windy-map-apikey').value.trim();
             const windyPointApiKey = localStorage.getItem('windy_api_key') || document.getElementById('input-windy-apikey').value.trim();
             
             const windyApiKey = windyMapApiKey || windyPointApiKey;
             
             if (!windyApiKey) {
                 alert('è¯·å…ˆè®¾ç½®Windy APIå¯†é’¥ï¼ˆmapï¼‰æˆ–ï¼ˆpointï¼‰');
                 return;
             }
             
             console.log('ä½¿ç”¨çš„Windy APIå¯†é’¥ç±»å‹:', windyMapApiKey ? 'mapå¯†é’¥' : 'pointå¯†é’¥');

             const options = {
                 key: windyApiKey,
                 lat: 30.4639,
                 lon: 106.5313,
                 zoom: 10,
                 // containerå‚æ•°ä¸éœ€è¦æŒ‡å®šï¼Œé»˜è®¤ä½¿ç”¨idä¸º'windy'çš„å®¹å™¨
             };

             console.log('å¼€å§‹åˆå§‹åŒ–Windyåœ°å›¾ï¼ŒAPIå¯†é’¥:', windyApiKey.substring(0, 10) + '...');
             
             // æ£€æŸ¥windyInitå‡½æ•°æ˜¯å¦å­˜åœ¨
             if (typeof windyInit === 'undefined') {
                 console.error('windyInitå‡½æ•°æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥Windy APIåº“æ˜¯å¦æ­£ç¡®åŠ è½½');
                 alert('Windy APIåº“æœªæ­£ç¡®åŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                 return;
             }
             
             windyInit(options, windyAPI => {
                 console.log('Windy APIå›è°ƒå‡½æ•°è¢«è°ƒç”¨');
                 const { map } = windyAPI;
                 windyMap = map;
                 console.log('Windyåœ°å›¾åˆå§‹åŒ–å®Œæˆï¼Œåœ°å›¾å¯¹è±¡:', map);
                 
                 // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬
                 map.on('click', function(e) {
                     if (currentMapType === 'windy') {
                         const lat = e.latlng.lat;
                         const lng = e.latlng.lng;
                         getAddress(lng, lat);
                         getWindyWeather(lat, lng);
                     }
                 });
             }).catch(error => {
                  console.error('Windyåœ°å›¾åˆå§‹åŒ–å¤±è´¥:', error);
                  
                  let errorMessage = 'Windyåœ°å›¾åˆå§‹åŒ–å¤±è´¥';
                  if (error.message && error.message.includes('Invalid API key')) {
                       errorMessage = 'âŒ Windy APIå¯†é’¥æ— æ•ˆï¼\n\nè¯·æ£€æŸ¥ï¼š\n1. ç¡®ä¿å·²åœ¨å³ä¸Šè§’è¾“å…¥æ¡†ä¸­è¾“å…¥æœ‰æ•ˆçš„Windy APIå¯†é’¥\n2. ç‚¹å‡»"ğŸ’¾ ä¿å­˜å¯†é’¥"æŒ‰é’®ä¿å­˜å¯†é’¥\n3. å¯åœ¨ https://api.windy.com/keys ç”³è¯·å…è´¹APIå¯†é’¥\n\nâš ï¸ ç”³è¯·APIå¯†é’¥æ—¶å¿…é¡»å¡«å†™ï¼š\nâ€¢ ç½‘ç«™URLï¼ˆå¦‚ï¼šhttps://mywebsite.comï¼‰\nâ€¢ åº”ç”¨IDï¼ˆå¦‚ï¼šmy.application.androidï¼‰\nâ€¢ æˆ–iOSåº”ç”¨IDï¼ˆå¦‚ï¼š1234567890ï¼‰\n\nå½“å‰é”™è¯¯: ' + error.message;
                  } else if (error.message && error.message.includes('Unauthorized')) {
                      errorMessage = 'âŒ Windy APIè®¿é—®æœªæˆæƒï¼\n\nè¯·ç¡®ä¿ï¼š\n1. APIå¯†é’¥æ ¼å¼æ­£ç¡®\n2. APIå¯†é’¥æœªè¿‡æœŸ\n3. APIå¯†é’¥æœ‰è¶³å¤Ÿçš„ä½¿ç”¨é…é¢\n\nè¯·è®¿é—® https://api.windy.com/keys æ£€æŸ¥æ‚¨çš„APIå¯†é’¥çŠ¶æ€';
                  } else {
                      errorMessage += ': ' + error.message;
                  }
                  
                  alert(errorMessage);
                  
                  // åˆ‡æ¢å›å¤©åœ°å›¾
                  document.getElementById('tianditu').checked = true;
                  switchMapType('tianditu');
              });
         }

        // åˆ‡æ¢åœ°å›¾ç±»å‹
        function switchMapType(mapType) {
            console.log('åˆ‡æ¢åœ°å›¾ç±»å‹åˆ°:', mapType);
            const tiandituDiv = document.getElementById('mapDiv');
            const windyDiv = document.getElementById('windy');
            
            if (mapType === 'windy') {
                tiandituDiv.style.display = 'none';
                windyDiv.style.display = 'block';
                currentMapType = 'windy';
                
                if (!windyMap) {
                    initWindyMap();
                }
            } else {
                tiandituDiv.style.display = 'block';
                windyDiv.style.display = 'none';
                currentMapType = mapType;
                
                // åˆ‡æ¢å¤©åœ°å›¾å›¾å±‚
                switchLayer(mapType);
            }
        }

        // ç›‘å¬åœ°å›¾ç±»å‹åˆ‡æ¢
        function setupMapTypeListeners() {
            const radioButtons = document.querySelectorAll('input[name="mapType"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        switchMapType(this.value);
                    }
                });
            });
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ç¡®ä¿APIå®Œå…¨åŠ è½½
            setTimeout(function() {
                if (typeof T !== 'undefined') {
                    console.log('å¤©åœ°å›¾APIå·²åŠ è½½');
                    initMap();
                    setupMapTypeListeners();
                    loadAllApiKeys(); // åŠ è½½æ‰€æœ‰ä¿å­˜çš„APIå¯†é’¥

                    // ç»çº¬åº¦åŠ è½½åï¼Œæ¨¡æ‹Ÿç‚¹å‡»â€œæŸ¥è¯¢â€æŒ‰é’®
                    document.getElementById('query-button').click();
                } else {
                    console.error('å¤©åœ°å›¾APIæœªåŠ è½½');
                    updateStatus('å¤©åœ°å›¾APIåŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    
                    // å°è¯•é‡æ–°åŠ è½½API
                    var tiandituApiKey = localStorage.getItem('tianditu_api_key') || document.getElementById('input-tianditu-key').value.trim();
                    if (!tiandituApiKey) {
                        updateStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤©åœ°å›¾APIå¯†é’¥');
                        return;
                    }
                    var script = document.createElement('script');
                    script.src = 'https://api.tianditu.gov.cn/api?v=4.0&tk=' + tiandituApiKey;
                    script.onload = function() {
                        console.log('é‡æ–°åŠ è½½APIæˆåŠŸ');
                        setTimeout(function() {
                            initMap();
                            setupMapTypeListeners();
                        }, 500);
                    };
                    script.onerror = function() {
                        console.error('é‡æ–°åŠ è½½APIä¹Ÿå¤±è´¥');
                        updateStatus('æ— æ³•è¿æ¥åˆ°å¤©åœ°å›¾æœåŠ¡å™¨');
                    };
                    document.head.appendChild(script);
                }
            }, 500);
        };
        
        console.log('è„šæœ¬åŠ è½½å®Œæˆ');
    </script>
    <!-- Leaflet JS for Windy Map -->
    <script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js"></script>
    <!-- Windy API -->
    <script src="https://api.windy.com/assets/map-forecast/libBoot.js" onload="console.log('Windy APIåº“åŠ è½½æˆåŠŸ')" onerror="console.error('Windy APIåº“åŠ è½½å¤±è´¥')"></script>
    <script>
        // æ£€æŸ¥Windy APIæ˜¯å¦åŠ è½½
        window.addEventListener('load', function() {
            setTimeout(function() {
                console.log('æ£€æŸ¥Windy APIçŠ¶æ€:');
                console.log('windyInitå‡½æ•°å­˜åœ¨:', typeof windyInit !== 'undefined');
                console.log('window.windyInitå­˜åœ¨:', typeof window.windyInit !== 'undefined');
                if (typeof windyInit === 'undefined' && typeof window.windyInit === 'undefined') {
                    console.warn('Windy APIå¯èƒ½æœªæ­£ç¡®åŠ è½½ï¼Œå°è¯•ä½¿ç”¨å¤‡ç”¨CDN');
                }
            }, 2000);
        });
    </script>
</body>
</html>
